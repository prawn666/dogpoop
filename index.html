<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ö–æ–º–ø–∞—Å</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 40px; }
    button { font-size: 20px; padding: 15px 30px; }
    #status { margin-top: 20px; color: green; }
  </style>
</head>
<body>
  <h1>üìç –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–ø–∞—Å–∞</h1>
  <p id="angle">–£–≥–æ–ª: –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</p>
  <button onclick="requestHeading()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–ø–∞—Å</button>
  <p id="status"></p>
  <script>
let lastHeading = null;

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
function sendHeading(heading) {
  const chatId = '407378418';
  const token = '8037753739:AAHNpW7v7g2hbTdNdV9KANmAjM09IWl9xMY';
  const url = `https://api.telegram.org/bot${token}/sendMessage`;
  const data = {
    chat_id: chat_id,
    text: `–£–≥–æ–ª: ${heading}¬∞`
  };

  fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≥–ª–∞
function getHeadingFromEvent(event) {
  if (event.webkitCompassHeading !== undefined) {
    return Math.round(event.webkitCompassHeading);
  } else if (event.alpha !== null) {
    return Math.round(360 - event.alpha);
  }
  return null;
}

// –õ–æ–≥–∏–∫–∞ —Å —Ä–µ—Ç—Ä–∞–µ–º
function handleOrientation(event) {
  let heading = getHeadingFromEvent(event);

  if (heading && heading !== 0 && heading !== 360) {
    lastHeading = heading;
    document.getElementById('angle').textContent = `–£–≥–æ–ª: ${heading}¬∞`;
    sendHeading(heading);
    window.removeEventListener("deviceorientation", handleOrientation);
  } else {
    document.getElementById('status').textContent = "–ö–æ–º–ø–∞—Å –¥—É–º–∞–µ—Ç...";

    // –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 500 –º—Å
    setTimeout(() => {
      window.addEventListener("deviceorientation", retryOnce, { once: true });
    }, 500);
  }
}

function retryOnce(event) {
  let heading = getHeadingFromEvent(event);

  if (heading && heading !== 0 && heading !== 360) {
    lastHeading = heading;
    document.getElementById('angle').textContent = `–£–≥–æ–ª: ${heading}¬∞`;
    sendHeading(heading);
  } else {
    // –ï—Å–ª–∏ –æ–ø—è—Ç—å 0 ‚Äî –ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
    setTimeout(() => {
      window.addEventListener("deviceorientation", retryOnce, { once: true });
    }, 1000);
  }
}

// –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞
function requestHeading() {
  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    DeviceOrientationEvent.requestPermission().then(response => {
      if (response === "granted") {
        window.addEventListener("deviceorientation", handleOrientation, { once: true });
      } else {
        alert("–î–æ—Å—Ç—É–ø –∫ –∫–æ–º–ø–∞—Å—É –æ—Ç–∫–ª–æ–Ω—ë–Ω");
      }
    });
  } else {
    window.addEventListener("deviceorientation", handleOrientation, { once: true });
  }
}
</script>

</body>
</html>


